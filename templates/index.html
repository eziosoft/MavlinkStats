<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drone MAVLink Stats</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f4; padding: 20px; }
        .container { display: flex; }
        .left, .right { padding: 20px; width: 50%; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid black; padding: 8px; text-align: left; }
        th { background-color: #ddd; }
        .good { background-color: lightgreen; }
        .bad { background-color: lightcoral; }
        .missing { color: red; font-weight: bold; }
        button { padding: 10px; background-color: red; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
<h2>Drone MAVLink Stats</h2>
<button id="resetButton">Reset Data</button>

<div class="container">
    <div class="left">
        <h3>Detected Systems</h3>
        <table id="systemsTable">
            <tr>
                <th>System ID</th>
                <th>Component ID</th>
            </tr>
        </table>

        <h3>REQUEST_DATA_STREAM Messages</h3>
        <table id="requestTable">
            <tr>
                <th>Requesting System</th>
                <th>Requesting Component</th>
                <th>Target System</th>
                <th>Target Component</th>
                <th>Command</th>
                <th>Requested Frequency (Hz)</th>
            </tr>
        </table>
    </div>

    <div class="right">
        <h3>Message Frequencies</h3>
        <p><b>Missing messages: <span id="missingMessages" class="missing"></span></b></p>
        <table id="messagesTable">
            <tr>
                <th>Message Type</th>
                <th>Source System</th>
                <th>Source Component</th>
                <th>Expected Frequency (Hz)</th>
                <th>Actual Frequency (Hz)</th>
            </tr>
        </table>
    </div>
</div>

<script>
    function fetchData() {
        $.getJSON("/drone_stats_data", function(data) {
            $("#systemsTable tr:gt(0)").remove();
            data.detected_systems.forEach(([system, component]) => {
                $("#systemsTable").append(`<tr><td>${system}</td><td>${component}</td></tr>`);
            });

            $("#messagesTable tr:gt(0)").remove();
            for (let [msg, details] of Object.entries(data.message_timestamps)) {
            let expected = data.expected_frequencies[msg] || "N/A";
            let actual = details.frequency.toFixed(2);
            let sourceSystem = details.source_system;
            let sourceComponent = details.source_component;

            $("#requestTable tr:gt(0)").remove();
            data.request_data_streams.forEach(req => {
                $("#requestTable").append(
                    `<tr>
                        <td>${req.requesting_system}</td>
                        <td>${req.requesting_component}</td>
                        <td>${req.target_system}</td>
                        <td>${req.target_component}</td>
                        <td>${req.command}</td>
                        <td>${req.frequency}</td>
                    </tr>`
                );
            });

            let rowClass = "";
            if (expected !== "N/A") {
                let lowerLimit = expected * 0.8;
                let upperLimit = expected * 1.2;
                rowClass = (actual < lowerLimit || actual > upperLimit) ? "bad" : "good";
            }

            $("#messagesTable").append(
                `<tr class="${rowClass}">
                    <td>${msg}</td>
                    <td>${sourceSystem}</td>
                    <td>${sourceComponent}</td>
                    <td>${expected}</td>
                    <td>${actual}</td>
                </tr>`
            );
            }

            let missingMessages = data.missing_messages.join(", ");
            $("#missingMessages").text(missingMessages);

            $("#requestTable tr:gt(0)").remove();
            data.request_data_streams.forEach(req => {
                $("#requestTable").append(`<tr><td>${req.requesting_system}</td><td>${req.requesting_component}</td><td>${req.target_system}</td><td>${req.target_component}</td><td>${req.command}</td><td>${req.frequency}</td></tr>`);
            });
        });
    }

    $("#resetButton").click(() => $.post("/reset", fetchData));

    setInterval(fetchData, 1000);
    fetchData();
</script>
</body>
</html>
